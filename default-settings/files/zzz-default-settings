#!/bin/sh

# lang
uci set luci.main.lang=en
uci commit luci

# timezone
uci set system.@system[0].timezone=WIB-7
uci set system.@system[0].zonename=Asia/Jakarta
# zram-swap
uci set system.@system[0].zram_priority=100
# ntp server
uci -q delete system.ntp.server
uci add_list system.ntp.server="time.indonesia.in"
uci add_list system.ntp.server="ntp.indosat.com"
uci add_list system.ntp.server="time3.jaring.id"
uci add_list system.ntp.server="time.cloudflare.com"  # Cloudflare's NTP server
uci commit system && service sysntpd reload

# uhttpd
uci set uhttpd.main.rfc1918_filter=0
uci set uhttpd.main.redirect_https=0
uci commit uhttpd && service uhttpd reload

# dnsmasq
uci set dhcp.lan.ra_management='1'
uci del dhcp.@dnsmasq[0].rebind_protection='1'
sed -i '/log-facility/d' /etc/dnsmasq.conf
echo "log-facility=/dev/null" >> /etc/dnsmasq.conf
uci commit dhcp

# xmm interface
uci set network.l860GL=interface
uci set network.l860GL.proto='xmm'
uci set network.l860GL.device='/dev/ttyACM0'
uci set network.l860GL.apn='internet'
uci set network.l860GL.auth='auto'
uci set network.l860GL.pdp='ipv4v6'
uci add_list network.l860GL.dns='8.8.8.8'
uci add_list network.l860GL.dns='8.8.4.4'
uci commit network
/etc/init.d/network restart

# Menambahkan aturan firewall
uci -q batch <<EOF
  set firewall.wan_l860GL=zone
  set firewall.wan_l860GL.name='wan_l860GL'
  set firewall.wan_l860GL.network='l860GL'
  set firewall.wan_l860GL.input='REJECT'
  set firewall.wan_l860GL.output='ACCEPT'
  set firewall.wan_l860GL.forward='REJECT'

  set firewall.wan_l860GL_m=forwarding
  set firewall.wan_l860GL_m.src='wan_l860GL'
  set firewall.wan_l860GL_m.dest='lan'

  commit firewall
EOF

# Restart layanan firewall
/etc/init.d/firewall restart

#opkg
sed -i 's/option check_signature/# option check_signature/g' /etc/opkg.conf
echo "src/gz custom_generic https://raw.githubusercontent.com/lrdrdn/my-opkg-repo/main/generic" >> /etc/opkg/customfeeds.conf
echo "src/gz custom_arch https://raw.githubusercontent.com/lrdrdn/my-opkg-repo/main/$(cat /etc/os-release | grep OPENWRT_ARCH | awk -F '"' '{print $2}')" >> /etc/opkg/customfeeds.conf

opkg remove --no-depends luci-app-pingcontrol

# cekip
echo -e '#!/bin/sh\n\nCONFIG_FILE="/etc/config/cekip_config"\nDEFAULT_DELAY=25\nfails=0\nmax_failures=5\n\nerror() {\n  echo "Error: $1" >&2\n  exit 1\n}\n\nsave_config() {\n  echo "interface=\"$interface\"" > "$CONFIG_FILE"\n}\n\nunset_config() {\n  rm -f "$CONFIG_FILE"\n}\n\nchoose_interface_prompt() {\n  echo "Pilih interface:"\n  interfaces=$(uci show network | grep -E "^network\.[^.]+=" | grep -v -E "^network\.(loopback|@device|globals)" | cut -d'\''.'\'' -f2 | cut -d'\''='\'' -f1)\n  counter=1\n  for iface in $interfaces; do\n    echo "$counter. $iface"\n    counter=$((counter+1))\n  done\n}\n\nchoose_interface() {\n  read -t $DEFAULT_DELAY -p "Masukkan nomor interface (default $DEFAULT_DELAY detik): " choice\n  if [ -z "$choice" ]; then\n    return\n  fi\n  if ! echo "$choice" | grep -qE '\''^[1-9][0-9]*$'\'' || [ "$choice" -ge "$counter" ]; then\n    error "Pilihan tidak valid."\n  fi\n  interface=$(echo "$interfaces" | awk -v choice="$choice" '\''NR==choice {print $1}'\'')\n  save_config\n}\n\nif [ -e "$CONFIG_FILE" ]; then\n  . "$CONFIG_FILE"\nfi\n\nif [ -n "$interface" ]; then\n  read -t $DEFAULT_DELAY -p "Ingin memilih kembali interface? (y/n, default $DEFAULT_DELAY detik): " choose_again\n  if [ "$choose_again" = "y" ]; then\n    unset interface\n    unset_config\n    choose_interface_prompt\n    choose_interface\n  else\n    echo "Menggunakan konfigurasi interface: $interface"\n  fi\nelse\n  choose_interface_prompt\n  choose_interface\nfi\n\nif uci show network."$interface" > /dev/null 2>&1; then\n  echo "Mendapatkan informasi untuk interface $interface..."\n  ubus_output=$(ubus call network.interface.$interface status)\n  device=$(echo "$ubus_output" | jq -r '"'"'.l3_device'"'"')\n  ip_address=$(echo "$ubus_output" | jq -r '"'"'.["ipv4-address"][0].address'"'"')\n  if [ "$device" = "null" ] || [ "$ip_address" = "null" ]; then\n    echo "Device atau Alamat IP tidak tersedia untuk interface $interface. Keluar dari skrip."\n    exit 1\n  fi\n  echo "Interface: $interface"\n  echo "Device: $device"\n  echo "Alamat IP: $ip_address"\n  timestamp=$(date "+%Y-%m-%d %H:%M:%S")\n  logger -t cekip "Skrip berjalan pada interface $interface - Device: $device, Alamat IP: $ip_address pada $timestamp"\n  while true; do\n    all_hosts_failed=true\n    for host in "google.com" "www.instagram.com" "mmg.whatsapp.net" "142.251.10.138" "31.13.95.174" "142.251.10.100"; do\n      ping -c 1 $host > /dev/null\n      if [ $? -eq 0 ]; then\n        echo "Ping OK to $host"\n      else\n        all_hosts_failed=false\n        if [ "$fails" -eq 2 ]; then\n          echo "Ping failed to $host. Restarting interface $interface..."\n          uci set network."$interface".ifname="$interface"\n          uci commit network\n          ifup "$interface"\n          fails=0\n        fi\n        fails=$((fails+1))\n        if [ "$fails" -ge "$max_failures" ]; then\n          echo "Script stopped due to consecutive failures exceeding the limit."\n          exit 1\n        fi\n      fi\n    done\n    if $all_hosts_failed; then\n      fails=0\n    fi\n    sleep 30\n  done\nelse\n  echo "Konfigurasi tidak ditemukan untuk interface $interface."\nfi\n' > /etc/bin/cekip && chmod +x /etc/bin/cekip

# remove modemfeed
sed -i '/src-git modemfeed https:\/\/github.com\/koshev-msk\/modemfeed.git/d' /etc/opkg/customfeeds.conf

# Fixing Bug
sed -i "/config uhttpd 'main'/a list interpreter '.php=/usr/bin/php-cgi'" /etc/config/uhttpd
sed -i "/config uhttpd 'main'/a option ubus_prefix '/ubus'" /etc/config/uhttpd

ln -sf /sbin/ip /usr/bin/ip

opkg flag hold luci-app-firewall
opkg flag hold firewall
opkg flag hold dnsmasq-full

# luci cache
rm -rf /tmp/luci-modulecache/
rm -f /tmp/luci-indexcache

exit 0
